---
title: ""
output:
  pdf_document:
    latex_engine: xelatex
geometry: margin=2cm
params:
  identite: NULL
  df_details: NULL
  radar_path: NULL
header-includes:
  - \usepackage{booktabs}
  - \usepackage{fontspec}
  - \setmainfont{DejaVu Sans}
  - \usepackage{graphicx}
  - \usepackage{xcolor}
  - \usepackage{booktabs}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - \fancyfoot[L]{\includegraphics[width=1.5cm]{www/region-nouvelle-aquitaine_logo.jpg}}
  - \fancyfoot[R]{\thepage}
  - \renewcommand{\headrulewidth}{0pt}
  - \renewcommand{\footrulewidth}{0.2pt}
  - \usepackage{xcolor}
  - \definecolor{bordeaux}{RGB}{128,0,32}
  - \usepackage{needspace}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
id  <- params$identite
res <- params$df_details
radar_path <- params$radar_path
```

```{=latex}
% Logo à droite
\noindent
\begin{tabular}{@{}p{0.75\linewidth}p{0.24\linewidth}@{}}
  & \raggedleft\includegraphics[width=3.5cm]{www/region-nouvelle-aquitaine_logo.jpg}
\end{tabular}

% ===== ESPACE CLAIR ENTRE LOGO ET TITRE =====
\vspace{1.2cm}

% Titre centré
\begin{center}
\colorbox{bordeaux!20}{%
  \parbox{1.2\linewidth}{%
    \vspace{0.2cm}
    \centering
    {\LARGE \textbf{Auto-diagnostic des transitions - Synthèse}}\\[0.15cm]
    \vspace{0.2cm}
  }%
}
\end{center}

\vspace{0.6cm}

```


```{r echo=FALSE, out.width="100%"}
knitr::include_graphics(radar_path)
```
```{r include=FALSE}
library(xtable)
```

```{r resultats, echo=FALSE, results='asis'}
sanitize <- function(x) {
  x <- gsub("\\\\", "/", x)
  x <- gsub("[\n\r]", " ", x)
  return(x)
}

barre_latex <- function(score) {
  filled <- score / 100 * 6
  empty  <- 6 - filled

  col <- if (score >= 80) {
    "49CC2B"
  } else if (score >= 50) {
    "6E9E62"
  } else if (score >= 20) {
    "EB6E26"
  } else {
    "CC1414"
  }
  
  paste0(
    "{\\color[HTML]{", col, "}\\rule{", round(filled, 2), "cm}{3pt}}",
    "{\\color{gray}\\rule{", round(empty, 2), "cm}{3pt}}",
    "\\hspace{0.3cm}", score, "\\%"
  )
}

for (th in themes) {

  # Il faut ~8cm libres sinon on saute de page
  cat("\\needspace{8cm}\n")

  cat("\\vspace{0.8cm}\n")
  
  d <- res[res$Theme == th, c("Objectif", "score_pct")]
  colnames(d) <- c("Objectif", "Score")
  
  # Score global de l’ambition
  score_ambition <- round(mean(d$Score, na.rm = TRUE))

  cat(
    "\\textbf{\\fontsize{10pt}{12pt}\\selectfont Ambition ",
    sanitize(th),
    "} \\hfill \\small Score : ",
    score_ambition,
    "\\%\n\n",
    sep = ""
    )

    if (nrow(d) > 0) {

    d$Objectif <- sanitize(d$Objectif)
    d$Barre <- sapply(d$Score, barre_latex)

    cat("\\begin{center}\n")
    cat("\\begin{tabular}{p{10cm}c}\n")
    cat("\\toprule\n")
    cat("Objectifs & Score \\\\\n")
    cat("\\midrule\n")

    for (i in 1:nrow(d)) {
      cat(d$Objectif[i], " & ", d$Barre[i], " \\\\\n", sep = "")
    }

    cat("\\bottomrule\n")
    cat("\\end{tabular}\n")
    cat("\\end{center}\n\n")

  } else {
    cat("Aucun objectif pour ce thème.\n\n")
  }
}

```

