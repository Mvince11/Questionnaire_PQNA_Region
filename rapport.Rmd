---
title: ""
output:
  pdf_document:
    latex_engine: xelatex
geometry: margin=2cm
params:
  identite: NULL
  df_details: NULL
  radar_path: NULL
header-includes:
  - \usepackage{booktabs}
  - \usepackage{fontspec}
  - \setmainfont{DejaVu Sans}
  - \usepackage{graphicx}
  - \usepackage{xcolor}
  - \usepackage{booktabs}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - \fancyfoot[L]{\includegraphics[width=1.5cm]{www/region-nouvelle-aquitaine_logo.jpg}}
  - \fancyfoot[R]{\thepage}
  - \renewcommand{\headrulewidth}{0pt}
  - \renewcommand{\footrulewidth}{0.2pt}
  - \usepackage{xcolor}
  - \definecolor{bordeaux}{RGB}{128,0,32}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
id  <- params$identite
res <- params$df_details
radar_path <- params$radar_path
```

```{=latex}
\begin{center}
\begin{minipage}{0.25\linewidth}
\includegraphics[width=3.5cm]{www/region-nouvelle-aquitaine_logo.jpg}
\end{minipage}
\begin{minipage}{0.70\linewidth}
\raggedleft
\colorbox{bordeaux!20}{%
  \parbox{\linewidth}{%
    \vspace{0.2cm}
    \raggedleft
    {\LARGE \textbf{Auto-diagnostic des transitions}}\\[0.15cm]
    {\Large SynthÃ¨se}
    \vspace{0.2cm}
  }%
}
\end{minipage}
\end{center}
\vspace{0.8cm}
```


```{r echo=FALSE, out.width="100%"}
knitr::include_graphics(radar_path)
```
```{r include=FALSE}
library(xtable)
```

```{r resultats, echo=FALSE, results='asis'}
library(stringi)

sanitize <- function(x) {
  x <- stringi::stri_trans_general(x, "Latin-ASCII")
  x <- gsub("\\\\", "/", x)
  x <- gsub("[\n\r]", " ", x)
  return(x)
}

barre_latex <- function(score) {
  filled <- score / 100 * 6
  empty  <- 6 - filled

  col <- if (score >=80){
    "#49CC2B"
  } else if (score >= 50) {
    "#6E9E62"
  } else if (score >= 20) {
      "orange" 
  } else {
      "red" 
    }

  paste0(
    "{\\color{", col, "}\\rule{", round(filled,2), "cm}{3pt}}",
    "{\\color{gray}\\rule{", round(empty,2), "cm}{3pt}}",
    "\\hspace{0.3cm}", score, "\\%"
  )
}

if (!is.null(res)) {

  themes <- unique(res$Theme)

  for (th in themes) {

    cat("Ambition ", sanitize(th), "\n\n")

    d <- res[res$Theme == th, c("Objectif", "score_pct")]
    colnames(d) <- c("Objectif", "Score")

    if (nrow(d) > 0) {

      d$Objectif <- sanitize(d$Objectif)
      d$Barre <- sapply(d$Score, barre_latex)

      cat("\\begin{center}\n")
      cat("\\begin{tabular}{p{10cm}c}\n")
      cat("\\toprule\n")
      cat("Objectif & Score \\\\\n")
      cat("\\midrule\n")

      for (i in 1:nrow(d)) {
        cat(d$Objectif[i], " & ", d$Barre[i], " \\\\\n", sep = "")
      }

      cat("\\bottomrule\n")
      cat("\\end{tabular}\n")
      cat("\\end{center}\n\n")

    } else {
      cat("Aucun objectif pour ce theme.\n\n")
    }
  }

} else {
  cat("**Aucun detail de resultats disponible.**")
}
```

